<%@ page language="java" contentType="text/html; charset=UTF-8" pageEncoding="UTF-8"%>
<%@include file="../module/head.jsp" %>

<!-- main-wrapper ÏïàÏóê sideBar/page-wrapper -->
<!-- page-wrapper ÏïàÏóê navbar/body-wrapper -->
<!-- body-wraaper ÏïàÏóê container-fluid -->
<!-- container-fluid ÏïàÏóê ÏûëÏóÖÌïòÏãúÎ©¥ Îê©ÎãàÎã§. -->
  
<body class="link-sidebar">
  <%@include file="../module/commonTags.jsp" %>
  <div id="main-wrapper" class="main-wrapper" >
    <%@include file="../module/sideBar.jsp" %>
    <div class="page-wrapper"> 
    <%@include file="../module/navBar.jsp" %>
	<div class="body-wrapper">
	    <div class="container-fluid">
			<div class="row">
			    <!-- Ï¢åÏ∏°: Ïõ∞Ïª¥ Ïπ¥Îìú -->
				<!-- Ïõ∞Ïª¥ Ïπ¥Îìú & Ïù¥ÎØ∏ÏßÄ Ïπ¥Îìú Ìïú Ï§Ñ Î∞∞Ïπò -->
				<div class="row d-flex align-items-stretch">
				    <!-- Ïõ∞Ïª¥ Ïπ¥Îìú -->
				    <div class="col-lg-6 d-flex">
				        <div class="card text-bg-primary flex-fill">
				            <div class="card-body d-flex flex-column">
				                <div class="row">
				                    <div class="col-sm-7">
				                        <div class="d-flex flex-column h-100">
				                            <div class="hstack gap-3">
				                                <span class="d-flex align-items-center justify-content-center round-48 bg-white rounded flex-shrink-0">
				                                    <iconify-icon icon="solar:course-up-outline" class="fs-7 text-muted"></iconify-icon>
				                                </span>
				                                <sec:authentication property="principal.memberVO.empVO.emplNm" var="userName"/>
				                                <h5 class="text-white fs-6 mb-0 text-nowrap">
				                                    Welcome Back <br>${userName}
				                                </h5>
				                            </div>
				                            <div class="mt-4 flex-grow-1">
				                                <ul class="list-unstyled">
				                                    <li>
				                                        <a href="/batirplan/message/received" class="text-white text-decoration-none d-flex align-items-center mt-2">
				                                            ‚úâÔ∏è ÏùΩÏßÄ ÏïäÏùÄ Ï™ΩÏßÄ <span id="unreadCount" class="badge bg-light text-dark ms-2">0Í±¥</span>
				                                        </a>
				                                    </li>
				                                    <li>
													    <a href="/batirplan/erp/electronicdocument/list" class="text-white text-decoration-none d-flex align-items-center mt-2">
													        üìù Ï†ÑÏûêÎ¨∏ÏÑú <span id="documentCount" class="badge bg-light text-dark ms-2">0Í±¥</span>
													    </a>
													</li>
				                                </ul>
				                            </div>
				                        </div>
				                    </div>
				                    <div class="col-sm-5 text-center text-md-end">
				                        <img src="/assets/images/backgrounds/welcome-bg.png" alt="welcome" class="img-fluid mb-n7 mt-2" style="max-height: 180px;">
				                    </div>
				                </div>
				            </div>
				        </div>
				    </div>

				    <!-- Ïù¥ÎØ∏ÏßÄ Ïπ¥Îìú -->
				    <div class="col-lg-6 d-flex">
				        <div class="row w-100">
				            <div class="col-md-6 d-flex">
				                <div class="card overflow-hidden shadow-none flex-fill">
				                    <div class="card-body p-0 h-100 d-flex align-items-center">
				                        <img src="/assets/images/logo.png" class="d-block w-100" alt="Static Image"
				                             style="height: 100%; object-fit: cover;">
				                    </div>
				                </div>
				            </div>
				            <div class="col-md-6 d-flex">
				                <div class="card overflow-hidden shadow-none flex-fill">
				                    <div id="imageSlider" class="carousel slide h-100 d-flex align-items-center"
				                         data-bs-ride="carousel" data-bs-interval="2000">
				                        <div class="carousel-inner h-100">
				                            <div class="carousel-item active h-100">
				                                <img src="/assets/images/main1.jpg" class="d-block w-100" alt="Slide 1"
				                                     style="height: 100%; object-fit: cover;">
				                            </div>
				                            <div class="carousel-item h-100">
				                                <img src="/assets/images/main2.jpg" class="d-block w-100" alt="Slide 2"
				                                     style="height: 100%; object-fit: cover;">
				                            </div>
				                        </div>
				                    </div>
				                </div>
				            </div>
				        </div>
				    </div>
				</div>

			<!-- Í≥µÏßÄÏÇ¨Ìï≠ & Ï†ÑÏûêÍ≤∞Ïû¨ Ìïú Ï§Ñ Î∞∞Ïπò (Ïó¨Î∞± Ï°∞Ï†ï) -->
			<div class="row mt-4 d-flex align-items-stretch">
			    <!-- Í≥µÏßÄÏÇ¨Ìï≠ -->
				<!-- Í≥µÏßÄÏÇ¨Ìï≠ -->
				    <div class="col-lg-6 d-flex">
				        <div class="card flex-fill">
				            <div class="card-body d-flex flex-column">
				                <h5 class="card-title"><span>üì¢</span> ÏµúÍ∑º Í≥µÏßÄÏÇ¨Ìï≠</h5>
				                <div class="table-responsive flex-grow-1">
				                    <table class="table table-hover mt-3">
				                        <thead class="table-dark">
				                            <tr>
				                                <th class="text-white text-center">Î≤àÌò∏</th>
				                                <th class="text-white text-center">Ï†úÎ™©</th>
				                                <th class="text-white text-center">ÏûëÏÑ±Ïùº</th>
				                            </tr>
				                        </thead>
				                        <tbody id="notice-list" class="text-center"></tbody> <!-- üîπ Ìñâ Í∞ÄÏö¥Îç∞ Ï†ïÎ†¨ -->
				                    </table>
				                </div>
				            </div>
				        </div>
				    </div>

			    <!-- Ï†ÑÏûêÍ≤∞Ïû¨ (Í≥µÏßÄÏÇ¨Ìï≠Í≥º ÎÜíÏù¥ ÎßûÏ∂§) -->
			    <div class="col-lg-6 d-flex">
			        <div class="card flex-fill">
			            <div class="card-body d-flex flex-column">
			                <h5 class="card-title"><span>üìù</span> Ï†ÑÏûêÍ≤∞Ïû¨ Î™©Î°ù</h5>
			                <div class="table-responsive flex-grow-1">
			                    <table class="table table-hover mt-3">
			                        <thead class="table-dark">
			                            <tr>
			                                <th class="text-white text-center">Ï†úÎ™©</th>
			                                <th class="text-white text-center">Í∏∞ÏïàÏùº</th>
			                                <th class="text-white text-center">ÏÉÅÌÉú</th>
			                                <th class="text-white text-center">Ïó≠Ìï†</th>
			                            </tr>
			                        </thead>
			                        <tbody id="approval-list"></tbody>
			                    </table>
			                </div>
			            </div>
			        </div>
			    </div>
			</div>


	                <!-- üîπ Ï†ÑÏûêÍ≤∞Ïû¨ Ïπ¥Îìú (Ï∫òÎ¶∞Îçî ÏïÑÎûò Î∞∞Ïπò) -->
	                <div class="card mt-4">
						<div class="col-lg-12">
					              <div class="card w-100" style="padding: 20px; border-radius: 10px; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);">
					                <div class="card-body">
					                  <h5 class="card-title">üìÖ ÌîÑÎ°úÏ†ùÌä∏ Ï∫òÎ¶∞Îçî</h5>
					                  <div id="dashboardCalendar" style="height: 500px;"></div>
					                </div>
					              </div>
					            </div>
					          </div>
					        </div> <!-- container-fluid ÎÅù -->
					      </div> <!-- body-wrapper ÎÅù -->
					    </div> <!-- page-wrapper ÎÅù -->
	                </div>
	            </div>
	        </div> <!-- row ÎÅù -->
			
			

			      <!-- -------------------------------------------- -->
			      <!-- Projects -->
			      <!-- -------------------------------------------- -->
			      <div class="col-md-6">
			        
			      </div>
			    </div>
			  </div>
			</div>
	    </div> <!-- container-fluid ÎÅù -->
	</div> <!-- body-wrapper ÎÅù -->
		  <!-- ÏûëÏóÖ ÏòÅÏó≠ Start -->
		  <sec:authentication property="principal.memberVO" var="mem"/>
		  <sec:authentication property="principal.memberVO.empVO" var="empl"/>

		  <!-- ÏûëÏóÖ ÏòÅÏó≠ End -->
		  </div>
	    </div>
    </div>
    </div>
  <%@include file="../module/footerScript.jsp" %>
  <!-- üìå Í≥µÏßÄÏÇ¨Ìï≠ & Ï†ÑÏûêÍ≤∞Ïû¨ Î∂àÎü¨Ïò§Í∏∞ JS -->
  <script>
      document.addEventListener("DOMContentLoaded", function() {
          console.log("üìå [INFO] ÌéòÏù¥ÏßÄ Î°úÎìú ÏôÑÎ£å, Îç∞Ïù¥ÌÑ∞ Í∞ÄÏ†∏Ïò§Í∏∞ ÏãúÏûë");

          // üìå Í≥µÏßÄÏÇ¨Ìï≠ Î∂àÎü¨Ïò§Í∏∞
          fetch('/api/notices/recent') 
              .then(response => response.json())
              .then(data => {
                  console.log("üìå Í≥µÏßÄÏÇ¨Ìï≠ API ÏùëÎãµ:", data); // ‚úÖ Í≥µÏßÄÏÇ¨Ìï≠ Îç∞Ïù¥ÌÑ∞ ÌôïÏù∏

                  let noticeList = document.getElementById("notice-list");
                  if (!noticeList) {
                      console.error("‚ùå Í≥µÏßÄÏÇ¨Ìï≠ Î¶¨Ïä§Ìä∏ ÏöîÏÜåÎ•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§!");
                      return;
                  }
                  noticeList.innerHTML = "";

                  if (!data || data.length === 0) {
                      noticeList.innerHTML = "<tr><td class='text-muted'>üì¢ ÏµúÍ∑º Í≥µÏßÄÏÇ¨Ìï≠Ïù¥ ÏóÜÏäµÎãàÎã§.</td></tr>";
                      return;
                  }
				  data.forEach((notice, index) => {
				      let tr = document.createElement("tr");

				      // üîπ Î≤àÌò∏
				      let tdNo = document.createElement("td");
				      tdNo.innerText = notice.bbscttNo; // Í≥µÏßÄÏÇ¨Ìï≠ Î≤àÌò∏ Ï∂îÍ∞Ä
				      tr.appendChild(tdNo);

				      // üîπ Ï†úÎ™©
				      let tdTitle = document.createElement("td");
				      let a = document.createElement("a");
				      a.href = "/batirplan/notice/detail/" + notice.bbscttNo;
				      a.classList.add("text-decoration-none", "text-dark");
				      a.innerText = notice.sj || "Ï†úÎ™© ÏóÜÏùå";
				      tdTitle.appendChild(a);
				      tr.appendChild(tdTitle);

				      // üîπ ÏûëÏÑ±Ïùº (YYYY-MM-DD Ìè¨Îß∑ Î≥ÄÌôò)
				      let tdDate = document.createElement("td");
				      if (notice.writingDt) {
				          let date = new Date(notice.writingDt);
				          let formattedDate = date.toISOString().split("T")[0]; // YYYY-MM-DD ÌòïÏãù
				          tdDate.innerText = formattedDate;
				      } else {
				          tdDate.innerText = "ÏóÜÏùå"; // Í∏∞Î≥∏Í∞í ÏÑ§Ï†ï
				      }
				      tr.appendChild(tdDate);

				      // üîπ ÌÖåÏù¥Î∏îÏóê Ï∂îÍ∞Ä
				      noticeList.appendChild(tr);
				  });
              })
              .catch(error => console.error("‚ùå Í≥µÏßÄÏÇ¨Ìï≠ Î°úÎî© Ïò§Î•ò:", error));

          // üìå Ï†ÑÏûêÍ≤∞Ïû¨ Î¶¨Ïä§Ìä∏ Î∂àÎü¨Ïò§Í∏∞ (Í∏∞ÏïàÏûê, Í≤∞Ïû¨Ïûê, Ï∞∏Ï°∞Ïûê Ìè¨Ìï®)
          fetch('/batirplan/main/electronicdocument/recent')
              .then(response => response.json())
              .then(data => {
                  console.log("üìå Ï†ÑÏûêÍ≤∞Ïû¨ API ÏùëÎãµ:", data); // ‚úÖ API Îç∞Ïù¥ÌÑ∞ ÌôïÏù∏ (ÎîîÎ≤ÑÍπÖÏö©)

                  let approvalList = document.getElementById("approval-list");
                  if (!approvalList) {
                      console.error("‚ùå Ï†ÑÏûêÍ≤∞Ïû¨ Î¶¨Ïä§Ìä∏ ÏöîÏÜåÎ•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§!");
                      return;
                  }
                  approvalList.innerHTML = "";

                  if (!data || data.length === 0) {
                      approvalList.innerHTML = "<tr><td colspan='4' class='text-muted'>üìå Ï°∞ÌöåÎêú Î¨∏ÏÑúÍ∞Ä ÏóÜÏäµÎãàÎã§.</td></tr>";
                      return;
                  }

				  data.forEach(doc => {
				      console.log("üìÑ Î¨∏ÏÑú Îç∞Ïù¥ÌÑ∞:", doc);  

				      let tr = document.createElement("tr");

				      // üîπ Ï†úÎ™© (ÌÅ¥Î¶≠ Ïãú ÏÉÅÏÑ∏ ÌéòÏù¥ÏßÄ Ïù¥Îèô)
				      let tdTitle = document.createElement("td");
				      let a = document.createElement("a");
				      a.href = "/batirplan/erp/electronicdocument/list?docNo=" + doc.DOCNO;
				      a.classList.add("text-decoration-none", "text-dark");

				      // üîπ Ï†úÎ™© Í∏∏Ïù¥ Ï†úÌïú (10Ïûê Ïù¥ÏÉÅÏù¥Î©¥ ... Ï≤òÎ¶¨)
				      let maxLength =10; // ÏõêÌïòÎäî ÏµúÎåÄ Í∏∏Ïù¥ (Ïòà: 20Ïûê)
				      let fullTitle = doc.TITLE || "Ï†úÎ™© ÏóÜÏùå";
				      let displayTitle = fullTitle.length > maxLength ? fullTitle.substring(0, maxLength) + "..." : fullTitle;

				      a.innerText = displayTitle;
				      a.title = fullTitle; // ÎßàÏö∞Ïä§ Ïò§Î≤Ñ Ïãú Ï†ÑÏ≤¥ Ï†úÎ™© ÌëúÏãú

				      tdTitle.appendChild(a);
				      tr.appendChild(tdTitle);
                      // üîπ Í∏∞ÏïàÏùº (YYYY-MM-DD Ìè¨Îß∑ÏúºÎ°ú Î≥ÄÌôò)
                      let tdDate = document.createElement("td");
                      if (doc.DRAFTDATE && typeof doc.DRAFTDATE === "string" && doc.DRAFTDATE.length === 8) {
                          let formattedDate = `\${doc.DRAFTDATE.substring(0, 4)}-\${doc.DRAFTDATE.substring(4, 6)}-\${doc.DRAFTDATE.substring(6, 8)}`;
                          tdDate.innerText = formattedDate;
                      } else {
                          console.warn("‚ö†Ô∏è Í∏∞ÏïàÏùº ÏóÜÏùå ÎòêÎäî Ìè¨Îß∑ Ïò§Î•ò:", doc.DRAFTDATE);
                          tdDate.innerText = "ÏóÜÏùå"; // ‚úÖ Í∏∞Î≥∏Í∞í ÏÑ§Ï†ï
                      }

                      // üîπ ÏÉÅÌÉú
  					let tdStatus = document.createElement("td");
  					            if (doc.STATUS === "01") {
  					                tdStatus.innerText = "Í∏∞Ïïà Ï§ë";
  					            } else if (doc.STATUS === "02") {
  					                tdStatus.innerText = "ÏßÑÌñâ Ï§ë";
  					            } else if (doc.STATUS === "03") {
  					                tdStatus.innerText = "Î∞òÎ†§";
  					            } else {
  					                tdStatus.innerText = "ÏôÑÎ£å";
  					            }	

  						// üîπ Ïó≠Ìï† (Í∏∞ÏïàÏûê / Í≤∞Ïû¨Ïûê Î≥ÄÌôò)
  						let tdRole = document.createElement("td");
  								   if (doc.USERROLE === "Í∏∞ÏïàÏûê") {
  								         tdRole.innerText = "Í∏∞ÏïàÏûê";
  								    } else if (doc.USERROLE === "Í≤∞Ïû¨Ïûê") {
  								           tdRole.innerText = "Í≤∞Ïû¨Ïûê";
  								    } else {
  								         tdRole.innerText = "Ï∞∏Ï°∞Ïûê"; // Í∑∏ Ïô∏Ïùò Í≤ΩÏö∞ ÎåÄÎπÑ
  								           }				

                      // üîπ ÌÖåÏù¥Î∏îÏóê Ï∂îÍ∞Ä (Ïò¨Î∞îÎ•¥Í≤å ÏÇΩÏûÖÎêòÏóàÎäîÏßÄ ÌôïÏù∏)
                      console.log("‚úÖ ÌÖåÏù¥Î∏î Ï∂îÍ∞Ä - Í∏∞ÏïàÏùº:", tdDate.innerText);
                      
                      tr.appendChild(tdTitle);
                      tr.appendChild(tdDate);
                      tr.appendChild(tdStatus);
                      tr.appendChild(tdRole);
                      approvalList.appendChild(tr);
                  });

                  console.log("‚úÖ ÏµúÏ¢ÖÏ†ÅÏúºÎ°ú ÌÖåÏù¥Î∏îÏóê Ï∂îÍ∞ÄÎêú ÏöîÏÜåÎì§:", approvalList.innerHTML);
              })
              .catch(error => console.error("‚ùå Ï†ÑÏûêÍ≤∞Ïû¨ Î°úÎî© Ïò§Î•ò:", error));
     
      
      $.ajax({
          url: "/batirplan/message/unreadCount",
          type: "GET",
          success: function (count) {
              $("#unreadCount").text(count + "Í±¥");
          },
          error: function () {
              console.error("ÏùΩÏßÄ ÏïäÏùÄ Ï™ΩÏßÄ Í∞úÏàòÎ•º Î∂àÎü¨Ïò§Îäî Îç∞ Ïã§Ìå®ÌñàÏäµÎãàÎã§.");
          }
      });
      
      $(document).ready(function () {
    	    $.ajax({
    	        url: "/batirplan/main/electronicdocument/count", // üìå Ï†ÑÏûêÎ¨∏ÏÑú Í∞úÏàò Í∞ÄÏ†∏Ïò§Îäî API
    	        type: "GET",
    	        success: function (count) {
    	            $("#documentCount").text(count + "Í±¥"); // ‚úÖ Í∞úÏàò ÏóÖÎç∞Ïù¥Ìä∏
    	        },
    	        error: function () {
    	            console.error("Ï†ÑÏûêÎ¨∏ÏÑú Í∞úÏàòÎ•º Î∂àÎü¨Ïò§Îäî Îç∞ Ïã§Ìå®ÌñàÏäµÎãàÎã§.");
    	        }
    	    });
    	});
      
      // üîπ Î©îÏù∏ ÌéòÏù¥ÏßÄ Ï∫òÎ¶∞Îçî (Ï†ÑÏ≤¥ ÌîÑÎ°úÏ†ùÌä∏ ÏùºÏ†ï Í∞ÄÏ†∏Ïò§Í∏∞)
      var calendarEl = document.getElementById('dashboardCalendar');
      if (calendarEl) {
          var calendar = new FullCalendar.Calendar(calendarEl, {
              locale: 'ko', 
              initialView: 'dayGridMonth',
              headerToolbar: {
                  left: 'prev,next today',
                  center: 'title',
                  right: ''
              },
              titleFormat: { year: 'numeric', month: 'long' },

              events: function (fetchInfo, successCallback, failureCallback) {
                  $.ajax({
                      url: "/batirplan/erp/calendar/getAllProjects", // ‚úÖ Ï†ÑÏ≤¥ ÌîÑÎ°úÏ†ùÌä∏ ÏùºÏ†ï API Ìò∏Ï∂ú
                      method: "GET",
                      success: function (events) {
                          console.log("üìå Ï†ÑÏ≤¥ ÌîÑÎ°úÏ†ùÌä∏ ÏùºÏ†ï Îç∞Ïù¥ÌÑ∞:", events);

                          let filteredEvents = events.filter(event => event.category === "ÌîÑÎ°úÏ†ùÌä∏");

                          let formattedEvents = filteredEvents.map(event => ({
                              id: event.eventId,
                              title: event.eventTitle,
                              start: event.startTime,
                              end: event.endTime,
                              description: event.eventDescription,
                              backgroundColor: event.backgroundColor || '#007bff',
                              borderColor: event.borderColor || '#0056b3'
                          }));

                          console.log("üìå ÌïÑÌÑ∞ÎßÅÎêú ÌîÑÎ°úÏ†ùÌä∏ ÏùºÏ†ï:", formattedEvents);
                          successCallback(formattedEvents);
                      },
                      error: function () {
                          console.error("üìå Ï∫òÎ¶∞Îçî Îç∞Ïù¥ÌÑ∞Î•º Î∂àÎü¨Ïò§Îäî Ï§ë Ïò§Î•ò Î∞úÏÉù!");
                      }
                  });
              }
          });

          calendar.render();
      } else {
          console.warn("‚ö†Ô∏è Ï∫òÎ¶∞ÎçîÎ•º ÌëúÏãúÌï† ÏöîÏÜåÎ•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§.");
      }
  });
      
  </script>
</body>
</html>